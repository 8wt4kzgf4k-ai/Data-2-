<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EUR/USD 5-Min Streak Pattern Scanner</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
#progressContainer { width: 80%; height: 30px; background-color: #eee; border: 1px solid #333; margin: 20px auto; border-radius: 5px; overflow: hidden; }
#progressBar { width: 0%; height: 100%; background-color: #4caf50; text-align: center; line-height: 30px; color: white; transition: width 0.2s; }
table { margin: 20px auto; border-collapse: collapse; width: 90%; }
th, td { border: 1px solid #333; padding: 8px; font-size: 12px; }
th { background-color: #4caf50; color: white; }
</style>
</head>
<body>

<h1>EUR/USD 5-Min Streak Pattern Scanner</h1>
<div id="progressContainer">
    <div id="progressBar">0%</div>
</div>
<div id="status">Starting...</div>

<table id="streakTable">
    <thead>
        <tr>
            <th>Type</th>
            <th>Start Time</th>
            <th>Streak Length</th>
            <th>Indicators</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
const apiKey = 'YOUR_API_KEY'; // replace with your Twelve Data API key
const totalCandles = 100;       // total candles to fetch
const batchSize = 8;            // max API requests per minute
let fetchedCandles = 0;

const progressBar = document.getElementById('progressBar');
const status = document.getElementById('status');
const tableBody = document.querySelector('#streakTable tbody');

// List of indicators to fetch
const indicatorsList = ['rsi', 'willr', 'sma', 'ema', 'macd', 'adx', 'cci']; 

function updateProgress() {
    const percent = Math.round((fetchedCandles / totalCandles) * 100);
    progressBar.style.width = percent + '%';
    progressBar.textContent = percent + '%';
}

function addStreakToTable(type, time, length, indicators) {
    const row = document.createElement('tr');
    const indicatorsText = Object.entries(indicators).map(([k, v]) => `${k}: ${v}`).join(', ');
    row.innerHTML = `<td>${type}</td><td>${time}</td><td>${length}</td><td>${indicatorsText}</td>`;
    tableBody.appendChild(row);
}

// Detect streaks of 4+ candles in one direction with no pullback
function detectStreaks(candles) {
    let streak = 1;
    for (let i = 1; i < candles.length; i++) {
        const prev = candles[i-1];
        const curr = candles[i];

        const isBull = curr.close > prev.close && curr.open >= prev.close;
        const isBear = curr.close < prev.close && curr.open <= prev.close;

        if ((isBull && !isBull) || (isBear && !isBear)) {
            streak = 1; // reset streak
        } else {
            streak++;
        }

        if (streak >= 4) {
            const startCandle = candles[i - streak + 1];
            addStreakToTable(isBull ? 'Bull' : 'Bear', startCandle.datetime, streak, startCandle.indicators);
        }
    }
}

async function fetchCandles(start = 0) {
    const outputsize = Math.min(batchSize, totalCandles - start);
    if (outputsize <= 0) return;

    status.textContent = `Fetching candles ${start + 1} to ${start + outputsize} of ${totalCandles}`;

    try {
        const indicatorParams = indicatorsList.join(',');
        const url = `https://api.twelvedata.com/time_series?symbol=EUR/USD&interval=5min&outputsize=${outputsize}&apikey=${apiKey}&format=JSON&indicators=${indicatorParams}`;
        const response = await fetch(url);
        const data = await response.json();

        const candles = data.values.map(c => {
            const ind = {};
            indicatorsList.forEach(indName => {
                if (c[indName] !== undefined) ind[indName] = c[indName];
            });
            return {
                datetime: c.datetime,
                open: parseFloat(c.open),
                high: parseFloat(c.high),
                low: parseFloat(c.low),
                close: parseFloat(c.close),
                indicators: ind
            };
        });

        detectStreaks(candles);

        fetchedCandles += outputsize;
        updateProgress();

        if (fetchedCandles < totalCandles && outputsize === batchSize) {
            status.textContent = 'Waiting 60s to respect API limit...';
            await new Promise(res => setTimeout(res, 60000));
        }

        await fetchCandles(fetchedCandles);
    } catch (err) {
        console.error('Error fetching candles:', err);
        status.textContent = 'Error fetching data';
    }
}

fetchCandles();
</script>
</body>
</html>
