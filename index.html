<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>5-Min Candle Streaks</title>
    <style>
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #333; padding: 8px; text-align: center; }
        th { background-color: #eee; }
    </style>
</head>
<body>
    <h1>5-Min Candle Streaks & Indicator Levels</h1>
    <table id="streakTable">
        <thead>
            <tr>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Direction</th>
                <th>Length</th>
                <th>RSI Levels</th>
                <th>Williams %R Levels</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
    const apiUrl = "b3f898dec7014a23aeddd60f2cb30fc6"; // Replace with your API
    const symbol = "EURUSD";
    const interval = "5m"; // 5-minute candles
    const limitPerRequest = 100;
    const totalCandlesNeeded = 500;
    const requestsNeeded = Math.ceil(totalCandlesNeeded / limitPerRequest);
    const sleepTime = 7500; // 7.5 seconds for 8 requests/min

    let allData = [];

    async function fetchCandleBatch(offset) {
        const url = `${apiUrl}?symbol=${symbol}&interval=${interval}&limit=${limitPerRequest}&start=${offset}`;
        const response = await fetch(url);
        if (!response.ok) {
            console.error("API Error", response.status);
            return [];
        }
        const data = await response.json();
        return data;
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function fetchAllCandles() {
        for (let i = 0; i < requestsNeeded; i++) {
            const offset = i * limitPerRequest;
            const batch = await fetchCandleBatch(offset);
            allData = allData.concat(batch);
            if (i < requestsNeeded - 1) await sleep(sleepTime);
        }
        processStreaks(allData);
    }

    function processStreaks(data) {
        const streaks = [];
        let streak = [];
        for (let i = 1; i < data.length; i++) {
            const prev = data[i - 1];
            const curr = data[i];

            // Determine candle direction
            const direction = curr.close > prev.close ? "UP" : curr.close < prev.close ? "DOWN" : "NEUTRAL";

            if (streak.length === 0) {
                if (direction !== "NEUTRAL") streak.push(curr);
            } else {
                const lastDirection = streak[0].close > streak[streak.length - 1].close ? "UP" : "DOWN";
                if (direction === lastDirection) {
                    streak.push(curr);
                } else {
                    if (streak.length >= 4) streaks.push(streak);
                    streak = direction !== "NEUTRAL" ? [curr] : [];
                }
            }
        }
        // Check last streak
        if (streak.length >= 4) streaks.push(streak);

        displayStreaks(streaks);
    }

    function displayStreaks(streaks) {
        const tbody = document.querySelector("#streakTable tbody");
        tbody.innerHTML = "";

        streaks.forEach(streak => {
            const rsiLevels = streak.map(c => c.rsi).join(", ");
            const williamsLevels = streak.map(c => c.williams).join(", ");
            const direction = streak[0].close > streak[streak.length - 1].close ? "UP" : "DOWN";

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${new Date(streak[0].time).toLocaleString()}</td>
                <td>${new Date(streak[streak.length - 1].time).toLocaleString()}</td>
                <td>${direction}</td>
                <td>${streak.length}</td>
                <td>${rsiLevels}</td>
                <td>${williamsLevels}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    fetchAllCandles();
    </script>
</body>
</html>
